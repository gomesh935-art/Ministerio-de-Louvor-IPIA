<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ministério de Louvor - IPI Aerolândia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white">Ministério de Louvor</h1>
            <p class="text-lg text-gray-400">IPI de Aerolândia</p>
        </header>
        <div class="flex justify-between items-center mb-6 p-4 bg-gray-800 rounded-lg shadow-md">
            <div>
                <label for="adminToggle" class="flex items-center cursor-pointer">
                    <span class="mr-3 font-medium text-white">Modo Edição</span>
                    <div class="relative">
                        <input type="checkbox" id="adminToggle" class="sr-only">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                </label>
            </div>
            <button id="addEventBtn" class="admin-control hidden bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
                <span class="ml-2 hidden sm:inline">Adicionar Evento</span>
            </button>
        </div>
        <main id="events-container" class="space-y-6"></main>
    </div>

    <!-- Modais (Evento, Senha, Exclusão) permanecem iguais ao index base -->

    <script type="module">
        import { supabase } from './supabase.js';
        document.addEventListener('DOMContentLoaded', () => {
            let events = [];
            let isAdminMode = false;

            const eventsContainer = document.getElementById('events-container');
            const adminToggle = document.getElementById('adminToggle');
            const dotElement = document.querySelector('label[for="adminToggle"] .dot');
            const addEventBtn = document.getElementById('addEventBtn');
            const modal = document.getElementById('eventModal');
            const modalTitle = document.getElementById('modalTitle');
            const eventForm = document.getElementById('eventForm');
            const eventIdInput = document.getElementById('eventId');
            const eventTitleInput = document.getElementById('eventTitle');
            const eventGroupInput = document.getElementById('eventGroup');
            const eventDateInput = document.getElementById('eventDate');
            const eventLocationInput = document.getElementById('eventLocation');
            const rehearsalDateInput = document.getElementById('rehearsalDate');
            const rehearsalTimeInput = document.getElementById('rehearsalTime');
            const eventSongsInput = document.getElementById('eventSongs');
            const spotifyLinkInput = document.getElementById('spotifyLink');
            const cancelBtn = document.getElementById('cancelBtn');

            const passwordModal = document.getElementById('passwordModal');
            const passwordForm = document.getElementById('passwordForm');
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');

            const deleteModal = document.getElementById('deleteConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            let eventToDeleteId = null;

            // --- Supabase integration ---
            async function loadEvents() {
                const { data, error } = await supabase
                  .from('eventos')
                  .select(`
                    id, titulo, local, data_evento, data_ensaio, hora_ensaio, spotify_link,
                    musicas (titulo, cantor),
                    eventos_grupos (grupos (nome))
                  `)
                  .order('data_evento', { ascending: true });
                if (error) { console.error(error); return; }
                events = data.map(ev => ({
                    id: ev.id,
                    title: ev.titulo,
                    location: ev.local,
                    date: ev.data_evento,
                    rehearsalDate: ev.data_ensaio,
                    rehearsalTime: ev.hora_ensaio,
                    spotifyLink: ev.spotify_link,
                    group: (ev.eventos_grupos && ev.eventos_grupos[0] && ev.eventos_grupos[0].grupos.nome) || '',
                    songs: (ev.musicas || []).map(m => m.cantor ? m.titulo + ' - ' + m.cantor : m.titulo)
                }));
                renderEvents();
            }

            async function saveEvent(e) {
                e.preventDefault();
                const id = eventIdInput.value;
                const newEvent = {
                    titulo: eventTitleInput.value,
                    local: eventLocationInput.value,
                    data_evento: eventDateInput.value,
                    data_ensaio: rehearsalDateInput.value,
                    hora_ensaio: rehearsalTimeInput.value,
                    spotify_link: spotifyLinkInput.value
                };
                if (id) {
                    await supabase.from('eventos').update(newEvent).eq('id', id);
                } else {
                    await supabase.from('eventos').insert(newEvent);
                }
                closeModal(modal);
                loadEvents();
            }

            async function deleteEventConfirmed() {
                if (eventToDeleteId) {
                    await supabase.from('eventos').delete().eq('id', eventToDeleteId);
                    loadEvents();
                }
                closeModal(deleteModal);
            }

            // --- Render ---
            function renderEvents() {
                eventsContainer.innerHTML = '';
                if (events.length === 0) {
                    eventsContainer.innerHTML = '<div class="bg-gray-800 p-8 rounded-lg text-center text-gray-400">Nenhum evento.</div>';
                    return;
                }
                events.forEach(event => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700';
                    div.innerHTML = `<h2 class="text-xl font-bold text-indigo-400">${event.title}</h2>`;
                    eventsContainer.appendChild(div);
                });
            }

            // --- Modal helpers ---
            const openModal = (m) => { m.classList.remove('invisible','opacity-0'); };
            const closeModal = (m) => { m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('invisible'),300); };

            // --- Admin mode ---
            function setAdminMode(enabled) {
                isAdminMode = enabled;
                adminToggle.checked = enabled;
                dotElement.style.transform = enabled ? 'translateX(1.5rem)' : 'translateX(0)';
                document.querySelectorAll('.admin-control').forEach(el => el.classList.toggle('hidden', !enabled));
            }

            adminToggle.addEventListener('click', (e) => {
                e.preventDefault();
                if (isAdminMode) setAdminMode(false);
                else openModal(passwordModal);
            });

            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (passwordInput.value === 'Gachiakuta') {
                    setAdminMode(true);
                    closeModal(passwordModal);
                } else passwordError.textContent = 'Senha incorreta';
            });

            cancelPasswordBtn.addEventListener('click', () => closeModal(passwordModal));
            cancelBtn.addEventListener('click', () => closeModal(modal));
            confirmDeleteBtn.addEventListener('click', deleteEventConfirmed);
            cancelDeleteBtn.addEventListener('click', () => closeModal(deleteModal));
            eventForm.addEventListener('submit', saveEvent);

            loadEvents();
        });
    </script>
</body>
</html>
